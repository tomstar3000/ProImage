(function(n){function r(n,t,i){if(i)this["_"+n]=t;else return this["_"+n]}var i=(n.Aurigma||(n.Aurigma={__namespace:!0}))&&(n.Aurigma.ImageUploader||(n.Aurigma.ImageUploader={__namespace:!0}));i.amazonS3Extender=function(n){if(!(this instanceof i.amazonS3Extender))return new i.amazonS3Extender(n);n.state()==1&&$au.debug().showError("AmazonS3Extender should be created before uploader initialization."),this._uploader=n,this._converters=new i.amazonS3Extender.converters,this._converterIndex=-1;var t=this;n.events().beforeSendRequest().add(function(){return t._onBeforeSendRequest.apply(t,arguments)}),n.events().initComplete().add(function(){return t._onInitComplete.apply(t,arguments)}),n.events().beforeUpload().add(function(){return t._onBeforeUpload.apply(t,arguments)})},i.amazonS3Extender.prototype={__class:!0,predefinedFields:{description:"Description_[itemIndex]",width:"Width_[itemIndex]",height:"Height_[itemIndex]",angle:"Angle_[itemIndex]",sourceName:"SourceName_[itemIndex]",horizontalResolution:"HorizontalResolution_[itemIndex]",verticalResolution:"VerticalResolution_[itemIndex]",sourceFileSize:"SourceSize_[itemIndex]",sourceCreatedDateTime:"SourceCreatedDateTime_[itemIndex]",sourceLastModifiedDateTime:"SourceLastModifiedDateTime_[itemIndex]",sourceCreatedDateTimeLocal:"SourceCreatedDateTimeLocal_[itemIndex]",sourceLastModifiedDateTimeLocal:"SourceLastModifiedDateTimeLocal_[itemIndex]",thumbnailSucceeded:"Thumbnail[converterIndex]Succeeded_[itemIndex]",fileMode:"File[converterIndex]Mode_[itemIndex]",fileSize:"File[converterIndex]Size_[itemIndex]",fileWidth:"File[converterIndex]Width_[itemIndex]",fileHeight:"File[converterIndex]Height_[itemIndex]",fileName:"File[converterIndex]Name_[itemIndex]",packageFileCount:"PackageFileCount",packageIndex:"PackageIndex",packageCount:"PackageCount",packageGuid:"PackageGuid",cropBounds:"CropBounds_[itemIndex]"},_prop:r,bucket:function(n){return this._prop("bucket",n,arguments.length)},accessKeyId:function(n){return this._prop("accessKeyId",n,arguments.length)},bucketHostName:function(n){return this._prop("bucketHostName",n,arguments.length)},checkIntegrity:function(n){return this._prop("checkIntegrity",n,arguments.length)},converters:function(n){if(arguments.length==0)return this._converters;this._converters.set(n)},_onBeforeSendRequest:function(){var v=this._uploader,a=++this._converterIndex%this._converterCount,n=v.metadata(),l="x-amz-meta-",f,i,o,r,t,s,u,e,c,h;n.enableAllStandardFields(!1),n.enableStandardField("File[converterIndex]_[itemIndex]",!0),n.renameStandardField("File[converterIndex]_[itemIndex]","file"),this.checkIntegrity()&&(n.enableStandardField("File[converterIndex]MD5_[itemIndex]",!0),n.renameStandardField("File[converterIndex]MD5_[itemIndex]","Content-MD5")),f=this.converters().get((a+this._converterCount-1)%this._converterCount).meta();if(f&&f.length>0)for(t=0,s=f.length;t<s;t++)u=f[t],u.name&&u.value!=null&&n.removeCustomField(l+u.name);i=this.converters().get(a);if(i){n.addCustomField("acl",i.acl()),n.addCustomField("key",i.key()),n.addCustomField("policy",i.policy()),n.addCustomField("signature",i.signature()),o=i.contentType(),o!=null&&o!=""?n.addCustomField("Content-Type",o):n.removeCustomField("Content-Type"),r=i.meta();if(r&&r.length>0)for(t=0,s=r.length;t<s;t++)u=r[t],e=u.name,e&&(c=r[t].value,h=r[t].field,h!=null?(n.renameStandardField(h,l+e),n.enableStandardField(h,!0)):c!=null&&n.addCustomField(l+e,c))}this._converterIndex=a},_onInitComplete:function(){var r=this._uploader,u=this.bucketHostName()?this.bucketHostName():this.bucket()+".s3.amazonaws.com",t=r.uploadSettings(),i;t.actionUrl(n.location.protocol+"//"+u),t.uploadConverterOutputSeparately(!0),t.filesPerPackage(1),r.type()=="java"&&t.enableHeadRequest(!1),t.chunkSize(0),i=r.metadata(),i.addCustomField("success_action_status","200"),i.addCustomField("AWSAccessKeyId",this.accessKeyId())},_onBeforeUpload:function(){var t,r,n,i;for(this._converterCount=this._uploader.converters().count(),this._converterIndex=-1,t=this._uploader.converters(),r=this.checkIntegrity()?"MD5":"",n=0,i=t.count();n<i;n++)t.get(n).hash(r)}},i.amazonS3Extender.prototype.constructor=i.amazonS3Extender,i.amazonS3Extender.converters=function(){if(!(this instanceof i.amazonS3Extender.converters))return new i.amazonS3Extender.converters;this._list={}},i.amazonS3Extender.converters.prototype={__class:!0,clear:function(){this._list={}},get:function(n){return this._list[n]||(this._list[n]=new i.amazonS3Extender.fileSettings),this._list[n]},remove:function(n){this._list.splice(n,1)},set:function(n){for(var f,r,t,u=0,e=n.length;u<e;u++){f=new i.amazonS3Extender.fileSettings,r=n[u],this._list[u]=f;for(t in r)(!r.hasOwnProperty||r.hasOwnProperty(t))&&(typeof f[t]=="function"?f[t](r[t]):showWarning('$au.amazonS3Extender.fileSettings has not "'+t+'" property.'))}}},i.amazonS3Extender.converters.prototype.constructor=i.amazonS3Extender.converters,i.amazonS3Extender.fileSettings=function(){if(!(this instanceof i.amazonS3Extender.fileSettings))return new i.amazonS3Extender.fileSettings;this._meta=[]},i.amazonS3Extender.fileSettings.prototype={__class:!0,_prop:r,acl:function(n){return this._prop("acl",n,arguments.length)},key:function(n){return this._prop("key",n,arguments.length)},policy:function(n){return this._prop("policy",n,arguments.length)},signature:function(n){return this._prop("signature",n,arguments.length)},contentType:function(n){return this._prop("contentType",n,arguments.length)},meta:function(n){return this._prop("meta",n,arguments.length)}},i.amazonS3Extender.fileSettings.prototype.constructor=i.amazonS3Extender.fileSettings})(window)