(function(b){var a=b.Aurigma?b.Aurigma.ImageUploader||{}:{};function c(a,c,b){if(b)this["_"+a]=c;else return this["_"+a]}a.amazonS3Extender=function(b){if(!(this instanceof a.amazonS3Extender))return new a.amazonS3Extender(b);b.state()==1&&$au.debug().showError("AmazonS3Extender should be created before uploader initialization.");this._uploader=b;this._converters=new a.amazonS3Extender.converters;this._converterIndex=-1;var c=this;b.events().beforeSendRequest().add(function(){return c._onBeforeSendRequest.apply(c,arguments)});b.events().initComplete().add(function(){return c._onInitComplete.apply(c,arguments)});b.events().beforeUpload().add(function(){return c._onBeforeUpload.apply(c,arguments)})};a.amazonS3Extender.prototype={__class:true,predefinedFields:{description:"Description_[itemIndex]",width:"Width_[itemIndex]",height:"Height_[itemIndex]",angle:"Angle_[itemIndex]",sourceName:"SourceName_[itemIndex]",horizontalResolution:"HorizontalResolution_[itemIndex]",verticalResolution:"VerticalResolution_[itemIndex]",sourceFileSize:"SourceSize_[itemIndex]",sourceCreatedDateTime:"SourceCreatedDateTime_[itemIndex]",sourceLastModifiedDateTime:"SourceLastModifiedDateTime_[itemIndex]",sourceCreatedDateTimeLocal:"SourceCreatedDateTimeLocal_[itemIndex]",sourceLastModifiedDateTimeLocal:"SourceLastModifiedDateTimeLocal_[itemIndex]",thumbnailSucceeded:"Thumbnail[converterIndex]Succeeded_[itemIndex]",fileMode:"File[converterIndex]Mode_[itemIndex]",fileSize:"File[converterIndex]Size_[itemIndex]",fileWidth:"File[converterIndex]Width_[itemIndex]",fileHeight:"File[converterIndex]Height_[itemIndex]",fileName:"File[converterIndex]Name_[itemIndex]",packageFileCount:"PackageFileCount",packageIndex:"PackageIndex",packageCount:"PackageCount",packageGuid:"PackageGuid",cropBounds:"CropBounds_[itemIndex]"},_prop:c,bucket:function(a){return this._prop("bucket",a,arguments.length)},accessKeyId:function(a){return this._prop("accessKeyId",a,arguments.length)},bucketHostName:function(a){return this._prop("bucketHostName",a,arguments.length)},converters:function(a){if(arguments.length==0)return this._converters;else this._converters.set(a)},_onBeforeSendRequest:function(){var m=this._uploader,g=++this._converterIndex%this._converterCount,a=m.metadata(),h="x-amz-meta-";a.enableAllStandardFields(false);a.enableStandardField("File[converterIndex]_[itemIndex]",true);a.renameStandardField("File[converterIndex]_[itemIndex]","file");var e=this.converters().get((g+this._converterCount-1)%this._converterCount).meta();if(e&&e.length>0)for(var b=0,l=e.length;b<l;b++){var f=e[b];f.name&&f.value!=null&&a.removeCustomField(h+f.name)}var d=this.converters().get(g);if(d){a.addCustomField("acl",d.acl());a.addCustomField("key",d.key());a.addCustomField("policy",d.policy());a.addCustomField("signature",d.signature());var c=d.meta();if(c&&c.length>0)for(var b=0,l=c.length;b<l;b++){var f=c[b],j=f.name;if(j){var k=c[b].value,i=c[b].field;if(i!=null){a.renameStandardField(i,h+j);a.enableStandardField(i,true)}else k!=null&&a.addCustomField(h+j,k)}}}this._converterIndex=g},_onInitComplete:function(){var d=this._uploader,e=this.bucketHostName()?this.bucketHostName():this.bucket()+".s3.amazonaws.com",a=d.uploadSettings();a.actionUrl(b.location.protocol+"//"+e);a.uploadConverterOutputSeparately(true);a.filesPerPackage(1);a.chunkSize(0);var c=d.metadata();c.addCustomField("success_action_status","200");c.addCustomField("AWSAccessKeyId",this.accessKeyId())},_onBeforeUpload:function(){this._converterCount=this._uploader.converters().count();this._converterIndex=-1}};a.amazonS3Extender.prototype.constructor=a.amazonS3Extender;a.amazonS3Extender.converters=function(){if(!(this instanceof a.amazonS3Extender.converters))return new a.amazonS3Extender.converters;this._list={}};a.amazonS3Extender.converters.prototype={__class:true,clear:function(){this._list={}},"get":function(b){if(!this._list[b])this._list[b]=new a.amazonS3Extender.fileSettings;return this._list[b]},remove:function(a){this._list.splice(a,1)},"set":function(f){for(var d=0,g=f.length;d<g;d++){var e=new a.amazonS3Extender.fileSettings,c=f[d];this._list[d]=e;for(var b in c)if(!c.hasOwnProperty||c.hasOwnProperty(b))if(typeof e[b]==="function")e[b](c[b]);else showWarning('$au.amazonS3Extender.fileSettings has not "'+b+'" property.')}}};a.amazonS3Extender.converters.prototype.constructor=a.amazonS3Extender.converters;a.amazonS3Extender.fileSettings=function(){if(!(this instanceof a.amazonS3Extender.fileSettings))return new a.amazonS3Extender.fileSettings;this._meta=[]};a.amazonS3Extender.fileSettings.prototype={__class:true,_prop:c,acl:function(a){return this._prop("acl",a,arguments.length)},key:function(a){return this._prop("key",a,arguments.length)},policy:function(a){return this._prop("policy",a,arguments.length)},signature:function(a){return this._prop("signature",a,arguments.length)},meta:function(a){return this._prop("meta",a,arguments.length)}};a.amazonS3Extender.fileSettings.prototype.constructor=a.amazonS3Extender.fileSettings;b.Aurigma=b.Aurigma||{__namespace:true};b.Aurigma.ImageUploader=a})(window)